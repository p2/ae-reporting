function _runRule(e,t){if(!_ruleCtrl){alert("There is no rule controller, cannot run rule!");return}_ruleCtrl.runRule(e,t)}function _reportRule(e,t){if(!_ruleCtrl){alert("There is no rule controller, cannot run rule!");return}_ruleCtrl.reportRule(e,t)}function _toggleSection(e){if(!_reportCtrl){alert("There is no process controller in place, cannot proceed");return}_reportCtrl.toggleSection($(e.target),e.data.section_id)}function _processNextSection(e){if(!_reportCtrl){alert("There is no process controller in place, cannot proceed");return}_reportCtrl.startNextSection($(e.target),e.data.section_id)}var _ruleCtrl=null,_reportCtrl=null,_globals={};$(document).ready(function(){window!=window.top&&$("#back_to_patient_select").hide();_ruleCtrl=new RuleController;_ruleCtrl.fetchRules()});var Rule=Base.extend({name:"",description:"",constructor:function(e){for(var t in e)this[t]=e[t]},hasPendingResults:function(){if(this.last_results&&this.last_results.length>0)for(var e=0;e<this.last_results.length;e++)if(this.last_results[e].flag)return!0;return!1},run:function(e){var t=this,n=$(e);n.text("Running...").attr("disabled",!0);$.ajax("rules/"+t.id+"/run_against/"+_record_id+"?api_base="+_api_base,{success:function(e){var r=n.parent().find(".rule_output").first();n.text("Check").removeAttr("disabled");if("ok"==e)r.is("*")?r.empty().html('<h3 class="green">No match</h3>'):alert("The rule did not match");else if(r.is("*")){r.empty().append('<h3 class="red">The rule did match</h3>').append("<pre/>");r.find("pre").first().text(e)}else alert("The rule did match");var i=$("#num_previous_checks_"+t.id);i.text(i.text()*1+1)},error:function(e,r,i){var s=n.parent().find(".rule_output").first();n.text("Try again").removeAttr("disabled");s.is("*")?s.empty().html('<h3 class="red">Failed to run rule '+t.name+": "+i+"</h3>"):alert("Failed to run rule "+t.name+": "+i)}})},report:function(e){_reportCtrl;_reportCtrl=new ProcessController(this);_reportCtrl.init(["demographics","adverse_event","medications","reporter"]);$("#rules").hide();$("#processing").show()},reportDidAbort:function(){$("#rules").show();$("#processing").hide();_reportCtrl=null}}),RuleController=Base.extend({loaded:!1,rules:[],fetchRules:function(){var e=this;$.get("rules/?api_base="+_api_base+"&record_id="+_record_id,function(t){if(t){var n=[];for(var r=0;r<t.length;r++)n.push(new Rule(t[r]));e.rules=n;e.loaded=!0;e.showRules()}else{alert('Invalid response for "rules/"');console.log("rules",t)}},"json")},showRules:function(){var e=[],t=[];for(var n=0;n<this.rules.length;n++){var r=this.rules[n];r.hasPendingResults()?e.push(r):t.push(r)}$("#rules").html("templates/rules.ejs",{inbox:e,rules:t})},runRule:function(e,t){var n=this._getRule(t);if(!n){alert("We don't have the rule \""+t+'"');return}n.run(e)},reportRule:function(e,t){var n=this._getRule(t);if(!n){alert("We don't have the rule \""+t+'"');return}n.report(e)},_getRule:function(e){for(var t=0;t<this.rules.length;t++)if(e==this.rules[t].id)return this.rules[t];return null}}),ProcessController=Base.extend({for_rule:null,sections:[],all:["demographics","adverse_event","medications","labs","reporter"],names:["Demographics & Vitals","Adverse Event","Medications","Labs","Reporter"],elem:null,constructor:function(e){this.for_rule=e},init:function(e){if(!e||e.length<1){alert("No sections to process, giving up");return}this.elem=$("#processing");this.elem.empty();this.sections=e;var t=$("<button/>").text("Abort"),n=this;t.click(function(){n.abort()});this.elem.append(t);var r=$("<div/>").addClass("rule_info");r.append("<h3>"+this.for_rule.name+"</h3>");r.append("<p>"+this.for_rule.description+"</p>");this.elem.append(r);for(var i=0;i<this.sections.length;i++)this._initSection(this.sections[i],this.names[i],0==i)},_initSection:function(e,t,n){if(!e||!this.elem){console.error("_initSection(), section_id",e,"elem",this.elem);return}var r=$("<div/>").attr("id","proc_"+e),i=$("<div/>").addClass("proc_header"),s=$("<h4/>").text(t?t:"Unknown Section");i.click({section_id:e},_toggleSection);i.append(s);r.append(i);this.elem.append(r);var o=$("<div/>").addClass("proc_body");o.html("<p>Loading...</p>");r.append(o);n&&r.addClass("active");this._loadDataForSection(e,o,n)},_loadDataForSection:function(e,t,n){var r=this;$.get("prefill/"+e+"?api_base="+_api_base+"&record_id="+_record_id,function(i){if(i){t.html("templates/process_"+e+".ejs",{data:i});var s=!1,o=$("<button/>").text("Proceed").click({section_id:e},_processNextSection),u=$("<div/>").addClass("process_next");u.append($("<p/>").append(o));t.append(u)}else{t.text('Invalid response for "prefill/'+e+'"');console.warn("rules",i)}n&&r._startSection(null,e)},"json")},_startSection:function(e,t){if(!t||!this.elem){console.error("_startSection(), section_id",t,"elem",this.elem);return}var n=$("#proc_"+t);n.addClass("active");n.find(".auto-kal").each(function(e,t){$(t).kalendae({format:"MM/DD/YYYY"})})},startNextSection:function(e,t){var n=null;for(var r=0;r<this.sections.length;r++)if(t==this.sections[r]){this.sections.length>r+1?n=this.sections[r+1]:this.finish();break}if(n){this._hideSection(e,t);this._startSection(e,n)}},toggleSection:function(e,t){var n=$("#proc_"+t);n.hasClass("active")?this._hideSection(e,t):this._startSection(e,t)},_hideSection:function(e,t){$("#proc_"+t).removeClass("active")},finish:function(e){alert("I don't know how to finish yet")},abort:function(e){this.for_rule.reportDidAbort()}});