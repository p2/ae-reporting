function compareMedByNameASC(e,t){return"sp:drugName"in e?"dcterms:title"in e["sp:drugName"]?"sp:drugName"in t?"dcterms:title"in t["sp:drugName"]?e["sp:drugName"]["dcterms:title"]<t["sp:drugName"]["dcterms:title"]?-1:e["sp:drugName"]["dcterms:title"]>t["sp:drugName"]["dcterms:title"]?1:0:-1:-1:1:1}function compareByDateDESC(e,t){return"date"in e?"date"in t?parseInt(e.date)<parseInt(t.date)?1:parseInt(e.date)>parseInt(t.date)?-1:0:-1:1}function toggleSection(e){if(!_reportCtrl){alert("There is no process controller in place, cannot proceed");return}_reportCtrl.toggleSection($(e.target),e.data.section_id)}function processNextSection(e){if(!_reportCtrl){alert("There is no process controller in place, cannot proceed");return}_reportCtrl.startNextSection($(e.target),e.data.section_id)}function addCheckableListItem(e,t){if(!e||!t){console.warn("addCheckableListItem(): I need a list item and an item name");return}var n=t+(new Date).getTime(),r='<input type="checkbox" name="'+t+'" value="" checked="checked" />';r+='<input type="text" id="'+n+'" name="'+n+'" />';r+='<a href="javascript:void(0);" class="small" onclick="$(this).parent().fadeOut(\'fast\', function(){$(this).remove();})">Remove</a>';r+="<br />";r+='<input type="text" class="small" id="supplement_'+n+'" name="supplement_'+n+'" placeholder="date range" style="margin-left:1.2em;" />';var i=$("<li/>").addClass("additional_item").html(r);$(e).before(i);$("#"+n).focus()}function showHideDeathHint(e){e&&!$("#death_date").val()?$("#death_date_hint").show():$("#death_date_hint").hide()}function _runRule(e,t){if(!_ruleCtrl){alert("There is no rule controller, cannot run rule!");return}_ruleCtrl.runRule(e,t)}function _reportRule(e,t){if(!_ruleCtrl){alert("There is no rule controller, cannot run rule!");return}_ruleCtrl.reportRule(e,t)}var _ruleCtrl=null,_reportCtrl=null,_globals={};$(document).ready(function(){if(window!=window.top){$("#patient_overview").hide();$("#back_to_patient_select").hide()}else $.ajax({url:"demographics",dataType:"json"}).always(function(e,t,n){var r="success"==t?e:"parsererror"==t?{}:null,i={};r?i=r:console.warn("no good response for demographics",e,n);console.log("demo",i);$("#patient_overview").html("templates/demographics.ejs",{demo:i})});_ruleCtrl=new RuleController;_ruleCtrl.fetchRules()});var Rule=Base.extend({name:"",description:"",constructor:function(e){for(var t in e)this[t]=e[t]},allChecksNegative:function(){if(this.last_results&&this.last_results.length>0){for(var e=0;e<this.last_results.length;e++)if(this.last_results[e].flag)return!1;return!0}return!1},latestResult:function(){var e=[];if(this.last_results&&this.last_results.length>0)for(var t=0;t<this.last_results.length;t++)e.push(this.last_results[t]);if(e.length<1)return null;e.sort(compareByDateDESC);return e[0]},hasPendingResults:function(){if(this.last_results&&this.last_results.length>0)for(var e=0;e<this.last_results.length;e++)if(this.last_results[e].flag)return!0;return!1},latestPendingResult:function(){var e=[];if(this.last_results&&this.last_results.length>0)for(var t=0;t<this.last_results.length;t++)this.last_results[t].flag&&e.push(this.last_results[t]);if(e.length<1)return null;e.sort(compareByDateDESC);return e[0]},run:function(e){var t=this,n=$(e);n.text("Running...").attr("disabled",!0);$.ajax("rules/"+t.id+"/run",{success:function(e){n.text("Check").removeAttr("disabled");var r=n.parentsUntil(".rule").parent();if("ok"==e){r.addClass("all_good");"rule_box"!=r.parent().attr("id")&&$("#rule_box").append(r)}else{r.removeClass("all_good");"rule_inbox"!=r.parent().attr("id")&&$("#rule_inbox").show().append(r)}var i=$("#num_previous_checks_"+t.id);i.text(i.text()*1+1)},error:function(e,r,i){var s=n.parent().find(".rule_output").first();n.text("Try again").removeAttr("disabled");s.is("*")?s.empty().html('<h3 class="red">Failed to run rule '+t.name+": "+i+"</h3>"):alert("Failed to run rule "+t.name+": "+i)}})},report:function(e){_reportCtrl&&console.warn("report controller is already present");_reportCtrl=new ProcessController(this);_reportCtrl.init(["demographics","adverse_event","medications","reporter"]);$("#rules").hide();$("#processing").show()},reportDidAbort:function(){$("#rules").show();$("#processing").hide();_reportCtrl=null}}),ProcessController=Base.extend({for_rule:null,sections:[],first:null,data:null,all:["demographics","adverse_event","medications","labs","reporter"],names:["Demographics & Vitals","Adverse Event","Medications","Labs","Reporter"],elem:null,constructor:function(e){this.for_rule=e},init:function(e){if(!e||e.length<1){alert("No sections to process, giving up");return}this.elem=$("#processing");this.elem.empty();this.sections=e;var t=$("<div/>").addClass("rule_info");t.append("<h3>Reporting: "+this.for_rule.name+"</h3>");t.append("<p>"+this.for_rule.description+"</p>");var n=this.for_rule.latestPendingResult();if(n){var r=moment(n.date*1e3),i=$("<div><p>This rule last triggered on <b>"+r.format("ll")+"</b> because:</b></div>"),s=n.results;if(s){var o=$("<ul/>");for(var u in s)for(var a=0;a<s[u].length;a++){var f=s[u][a];console.log(u," -- ",f);o.append("<li><b>"+u+"</b>: "+f+"</li>")}i.append(o)}t.append(i)}var l=$("<button/>").text("Done Reporting"),c=this;l.click(function(){c.abort()});t.append(l);this.elem.append(t);this.first=null;for(var a=0;a<this.all.length;a++)if($.inArray(this.all[a],e)>=0){this._initSection(this.all[a],this.names[a],!this.first);this.first||(this.first=this.all[a])}if("actions"in this.for_rule){var h=$("<div/>").attr("id","proc_actions"),p=$("<div/>").addClass("proc_header"),d=$("<h4/>").text("Review and Report");p.click({section_id:"actions"},toggleSection);p.append(d);h.append(p);var v=$("<div/>").addClass("proc_body");for(var a=0;a<this.for_rule.actions.length;a++){var m=this.for_rule.actions[a];if("form"in m){var g=$("<form/>").attr("method","post").attr("action","forms/"+m.form).attr("target","_blank");g.addClass("process_form");g.submit(function(){var e=g.find('input[name="json"]');if(!e.is("*")){e=$("<input/>").attr("type","hidden").attr("name","json");g.prepend(e)}e.val(c.finish());return!0});g.append("<h4>"+m.name+"</h4>");var y=$("<p/>");y.append('<button type="submit">Preview...</button>');g.append(y);v.append(g)}else console.warn("This action does not have a form to submit: ",m)}h.append(v);this.elem.append(h)}this._loadData()},_initSection:function(e,t,n){if(!e||!this.elem){console.error("_initSection(), section_id",e,"elem",this.elem);return}var r=$("<div/>").attr("id","proc_"+e),i=$("<div/>").addClass("proc_header"),s=$("<h4/>").text(t?t:"Unknown Section");i.click({section_id:e},toggleSection);i.append(s);r.append(i);this.elem.append(r);var o=$("<div/>").addClass("proc_body");o.html("<p>Loading...</p>");r.append(o);n&&r.addClass("active")},_loadData:function(){var e=this,t=this.sections.join("+");$.ajax({url:"prefill/"+t,dataType:"json"}).always(function(n,r,i){var s="success"==r?n:"parsererror"==r?{}:null;s?e.data=s:console.warn("no good response for sections",t,n,i);e._startSection(null,e.first)})},_startSection:function(e,t){if(!t||!this.elem){console.error("_startSection(), section_id",t,"elem",this.elem);return}var n=$("#proc_"+t);n.addClass("active");var r=n.find(".proc_body").first();if(r.is(":empty")||"Loading..."==r.text()){r.html("templates/process_"+t+".ejs",{data:this.data,rule:this.for_rule});var i=$("<button/>").text("Proceed").click({section_id:t},processNextSection),s=$("<p/>").addClass("process_next");s.append(i);r.append(s);r.find(".auto-kal").each(function(e,t){$(t).kalendae({format:"MM/DD/YYYY"})})}},startNextSection:function(e,t){var n=null;for(var r=0;r<this.sections.length;r++)if(t==this.sections[r]){this.sections.length>r+1?n=this.sections[r+1]:n="actions";break}if(n){this._hideSection(e,t);this._startSection(e,n)}},toggleSection:function(e,t){var n=$("#proc_"+t);n.hasClass("active")?this._hideSection(e,t):this._startSection(e,t)},_hideSection:function(e,t){$("#proc_"+t).removeClass("active")},finish:function(e){var t={};for(var n=0;n<this.sections.length;n++){var r=$("#form_"+this.sections[n]);if(!r.is("*"))console.warn("Form for section",this.sections[n],"is missing",this.sections);else{var i=r.serializeArray(),s={};for(var o=0;o<i.length;o++){var u=i[o],a=u.name,f=u.value;if(a in s){var l=s[a];"object"!=typeof l&&(l=[l]);l.push(f);s[a]=l}else s[a]=f}t[this.sections[n]]=s}}t.now=moment().format("MM/DD/YYYY");return JSON.stringify(t)},abort:function(e){this.for_rule.reportDidAbort()}}),RuleController=Base.extend({loaded:!1,rules:[],fetchRules:function(){var e=this;$.get("rules/",function(t){if(t){var n=[];for(var r=0;r<t.length;r++)n.push(new Rule(t[r]));e.rules=n;e.loaded=!0;e.showRules()}else{alert('Invalid response for "rules/"');console.log("rules",t)}},"json")},showRules:function(){var e=[],t=[];for(var n=0;n<this.rules.length;n++){var r=this.rules[n];r.hasPendingResults()?e.push(r):t.push(r)}$("#rules").html("templates/rules.ejs",{inbox:e,rules:t})},runRule:function(e,t){var n=this._getRule(t);if(!n){alert("We don't have the rule \""+t+'"');return}n.run(e)},reportRule:function(e,t){var n=this._getRule(t);if(!n){alert("We don't have the rule \""+t+'"');return}n.report(e)},_getRule:function(e){for(var t=0;t<this.rules.length;t++)if(e==this.rules[t].id)return this.rules[t];return null}});